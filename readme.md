# Anime-Dimension API (ASP.NET Core, SQLite)

This is the standalone C# backend for Anime-Dimension. It provides minimal HTTP APIs for authentication, user management, suggestions, notifications, and serving pre-generated static API assets. The project targets .NET 8.0 and .NET 9.0 and uses SQLite via Entity Framework Core.

## goal
to provide a lightweight backend for the Anime-Dimension frontend, handling user accounts, sessions, and dynamic data.
to provide a public api site hosted within the api server that serves the pre-generated static assets from the main anime-dimension project to provide anyone with a way to register and access the apis data
to maintain similar function to the anime-planet site based on observed behavior.

## Important notes

> NOTE: the `./api/www/api/**` files are all pregenerated by the main parent project Anime-Dimension, and are not included in the repo.
> there are two DB's `anime-dimension.db` `users.db` generated by the 'Anime-Dimension-Database-Orchestrator' that are not included in git or the parent project, the users db cannot be obtained and the anime-dimension.db will in the future be made available via a cdn, for now its unavailable, the db orchestrator is its own independent submodule and will not be made public ever.


Keep those files in the repo for development, but avoid editing the pre-generated assets directly.

## Features

- Minimal APIs (ASP.NET Core) with JSON responses
- SQLite storage with EF Core DbContexts
	- `ApiDbContext` for Animes, Users, Notifications
	- `UsersDbContext` for Users and UserSessions
- Static file serving for pre-generated assets under `api/www/api`
- Endpoints for: validation, auth/login/logout, suggestions, notifications, users, and more

## Requirements

- .NET SDK 10.0
- SQLite database files:
	- `anime-dimension.db` – data obtained from many sources and colated by the Database Orchestrator
	- `users.db` – user accounts and sessions

## Project structure (key parts)

- `Program.cs` – application bootstrap, service wiring, SQLite file checks/copy helpers
- `api/` – minimal API endpoint definitions
	- `auth.cs`, `login.cs`, `logout.cs`, `users.cs`, `validation.cs`, `suggestions.cs`, `notifications.cs`, `anime.cs`, `www.cs`
- `models/` – POCO models (User, UserSession, Anime, Notification)
- `sql/` – EF Core DbContexts and factories (`ApiDbContext`, `UsersDbContext`)
- `Serialization/` – JSON serialization context
- `api/www/api/**` – pre-generated static assets copied from the main project, not included in git


## Running locally

From the repository root or this project folder:

```powershell
# Restore and run (Development)
dotnet restore .\Anime-dimension-api\ASP.NETCoreWebApi.csproj
dotnet run --project .\Anime-dimension-api\ASP.NETCoreWebApi.csproj
```

Then open the URL shown in the console output (Kestrel). On first run, ensure the SQLite files listed above exist. The app includes checks to validate connectivity and the presence of required tables.

### Build and publish

```powershell
dotnet build .\Anime-dimension-api\ASP.NETCoreWebApi.csproj -c Release
dotnet publish .\Anime-dimension-api\ASP.NETCoreWebApi.csproj -c Release -r linux-x64 --self-contained false
```

The `.csproj` ensures DB files and `api/www/api/**` assets are copied to the publish directory and kept outside any single-file bundle.

## Endpoints overview

Below is an at-a-glance map of implemented endpoints. For full details, see the source files under `api/`.

- Validation
	- `POST /api/validation/username` – validate a new user’s username; checks alphanumeric and availability

- Auth & Login
	- `POST /api/auth/signup-token` – issues a temporary token for signup flows
	- `PUT  /api/login/validateState` – validates login state token
	- `POST /api/logout` – clears session by cookie or request body token

- Users
	- `GET  /api/users/profile?username=...` – fetch a public user profile (and related bootstrapping)
	- Additional user endpoints are implemented in `api/users.cs`

- Suggestions
	- `POST /api/suggestions/get` – returns a suggestions list (default 12; accepts `totalRequested` with bounds)
	- `POST /api/suggestions/popular_this_week` – returns popular-this-week list
	- `POST /api/suggestions/this_season` – returns this-season list

- Notifications
	- `GET  /api/notifications` – returns notifications with compact time-ago formatting

- Anime
	- Endpoints are defined in `api/anime.cs` (various utility and safety helpers are included)

- Static API site/assets
	- Static files under `api/www/api/**` are served by `api/www.cs` (content types are mapped explicitly)

## Data access

- Entity Framework Core contexts
	- `ApiDbContext` with DbSets: `Animes`, `Users`, `Notifications`
	- `UsersDbContext` with DbSets: `Users`, `UserSessions`
- Direct `Microsoft.Data.Sqlite` commands are also used in some endpoints for table existence checks and bootstrap data insertion.

## Security considerations

- Password hashing uses PBKDF2 (Rfc2898DeriveBytes with SHA-256, 100k iterations) – see `helpers/auth.cs`.
- Session tokens are stored in `users.db` and may be passed via secure cookie (`session_token`) or request body depending on the client.
- This is a development-friendly server; review production hardening (HTTPS, CORS, cookie flags, secret storage, rate limiting) before internet exposure.

## Development tips

- Do not edit `api/www/api/**` files directly. Regenerate them via the main Anime-Dimension build when needed.
- If a DB file is missing, the server will not have data for the related endpoints. Obtain the DB artifacts per the note above.
- When changing public behavior, consider adding or updating endpoint-level tests (not included yet in this project).

## License

See the repository license. This subproject follows the main repo’s licensing terms.


NOTE: the ./api/www/api/** files are all pregenerated by the main parant project Anime-Dimension using the core astro build process and the asset-handler and these files should not be directly modified, but they should remain in the source code to ensure the server can be used and developed without the main AD project

there are three seperate DB files anime-dimension.db generated by and handled by the Anime-Dimension-Database-Orchestrator that may exist in the parent project but is its own independent submodule and will not always exist, it is not included in git and must be obtained to run the server
the anime.db file is for other data but it may be better to faze it out, currently only stores notifications 
the users.db is the users db, not in git



